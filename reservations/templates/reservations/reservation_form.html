{% extends 'base.html' %}
{% load static %}

{% block title %}
    {% if object %}Edit Reservation{% else %}New Reservation{% endif %} - Laundry Pal
{% endblock %}

{% block extra_css %}
<link href="{% static 'css/reservation-form.css' %}" rel="stylesheet">
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/reservation-enhanced.js' %}"></script>
{% endblock %}

{% block content %}
<div class="reservation-container">
    <!-- Hero Header Section -->
    <section class="reservations-hero">
        <!-- Floating Laundry Icons -->
        <div class="floating-reservations-icons">
            <i class="fas fa-calendar-check floating-icon-res icon-res-1"></i>
            <i class="fas fa-clock floating-icon-res icon-res-2"></i>
            <i class="fas fa-tshirt floating-icon-res icon-res-3"></i>
            <i class="fas fa-truck floating-icon-res icon-res-4"></i>
            <i class="fas fa-check-circle floating-icon-res icon-res-5"></i>
            <i class="fas fa-calendar-alt floating-icon-res icon-res-6"></i>
            <i class="fas fa-box floating-icon-res icon-res-7"></i>
            <i class="fas fa-sparkles floating-icon-res icon-res-8"></i>
        </div>
        
        <div class="hero-content">
            <div class="hero-badge">
                <i class="fas fa-calendar-plus"></i>
                <span>{% if object %}Edit Reservation{% else %}New Reservation{% endif %}</span>
            </div>
            <h1 class="hero-title">{% if object %}Edit Reservation{% else %}Schedule Pickup{% endif %}</h1>
            <p class="hero-subtitle">{% if object %}Update your reservation details{% else %}Book your laundry pickup and delivery{% endif %}</p>
        </div>
    </section>

    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-10">

                <!-- Form Card -->
                <div class="reservation-card">
                    <div class="p-4">
                    <form method="post" class="needs-validation" novalidate>
                        {% csrf_token %}
                        
                        <!-- Service Type Selection -->
                        <div class="section-header">
                            <i class="fas fa-cog" style="color: #2563eb;"></i>
                            <h3>Service Type</h3>
                        </div>
                        <div style="display: none;">
                            {{ form.service_type }}
                        </div>
                        <div class="service-grid">
                            <div class="service-card">
                                <input type="radio" name="service_type_display" id="wash_fold" value="1" data-target="service_type">
                                <label class="service-label" for="wash_fold">
                                    <i class="fas fa-tshirt service-icon" style="color: #2563eb;"></i>
                                    <div class="service-name">Wash & Fold</div>
                                    <div class="service-price">₱750 base + ₱100/item</div>
                                </label>
                            </div>
                            <div class="service-card">
                                <input type="radio" name="service_type_display" id="dry_cleaning" value="2" data-target="service_type">
                                <label class="service-label" for="dry_cleaning">
                                    <i class="fas fa-user-tie service-icon" style="color: #06b6d4;"></i>
                                    <div class="service-name">Dry Cleaning</div>
                                    <div class="service-price">₱1,250 base + ₱400/item</div>
                                </label>
                            </div>
                            <div class="service-card">
                                <input type="radio" name="service_type_display" id="premium_care" value="3" data-target="service_type">
                                <label class="service-label" for="premium_care">
                                    <i class="fas fa-crown service-icon" style="color: #fbbf24;"></i>
                                    <div class="service-name">Premium Care</div>
                                    <div class="service-price">₱1,750 base + ₱250/item</div>
                                </label>
                            </div>
                        </div>

                        <!-- Priority Selection -->
                        <div class="section-header">
                            <i class="fas fa-exclamation-circle" style="color: #fbbf24;"></i>
                            <h3>Priority Level</h3>
                        </div>
                        <div style="display: none;">
                            {{ form.priority }}
                        </div>
                        <div class="priority-grid">
                            <div class="priority-card priority-standard">
                                <input type="radio" name="priority_display" id="standard" value="standard" data-target="priority" checked>
                                <label class="priority-label" for="standard">
                                    <i class="fas fa-clock priority-icon"></i>
                                    <div class="priority-name">STANDARD<br>(3-5 DAYS)</div>
                                </label>
                            </div>
                            <div class="priority-card priority-express">
                                <input type="radio" name="priority_display" id="express" value="express" data-target="priority">
                                <label class="priority-label" for="express">
                                    <i class="fas fa-shipping-fast priority-icon"></i>
                                    <div class="priority-name">EXPRESS (24H)<br>+₱500</div>
                                </label>
                            </div>
                            <div class="priority-card priority-rush">
                                <input type="radio" name="priority_display" id="rush" value="rush" data-target="priority">
                                <label class="priority-label" for="rush">
                                    <i class="fas fa-bolt priority-icon"></i>
                                    <div class="priority-name">RUSH (SAME DAY)<br>+₱1,250</div>
                                </label>
                            </div>
                        </div>

                        <!-- Schedule Section -->
                        <div class="section-header">
                            <i class="fas fa-calendar-alt" style="color: #2563eb;"></i>
                            <h3>Pickup & Delivery Schedule</h3>
                        </div>
                        <div class="datetime-grid">
                            <div class="form-group">
                                <label for="{{ form.pickup_datetime.id_for_label }}" class="form-label">
                                    <i class="fas fa-arrow-up" style="color: #2563eb;"></i>Pickup Date & Time
                                </label>
                                <input type="datetime-local" 
                                       class="form-control" 
                                       id="{{ form.pickup_datetime.id_for_label }}" 
                                       name="{{ form.pickup_datetime.name }}" 
                                       value="{{ form.pickup_datetime.value|default:'' }}"
                                       required>
                            </div>
                            <div class="form-group">
                                <label for="{{ form.delivery_datetime.id_for_label }}" class="form-label">
                                    <i class="fas fa-arrow-down" style="color: #06b6d4;"></i>Delivery Date & Time
                                </label>
                                <input type="datetime-local" 
                                       class="form-control" 
                                       id="{{ form.delivery_datetime.id_for_label }}" 
                                       name="{{ form.delivery_datetime.name }}" 
                                       value="{{ form.delivery_datetime.value|default:'' }}"
                                       required>
                            </div>
                        </div>

                        <!-- Address Section -->
                        <div class="section-header">
                            <i class="fas fa-map-marker-alt" style="color: #ef4444;"></i>
                            <h3>Contact Information</h3>
                        </div>
                        <div class="form-group" style="margin-bottom: 1.5rem;">
                            <label for="{{ form.address.id_for_label }}" class="form-label">
                                <i class="fas fa-map-marker-alt" style="color: #ef4444;"></i>Pickup & Delivery Address
                            </label>
                            <textarea class="form-control" 
                                      id="{{ form.address.id_for_label }}" 
                                      name="{{ form.address.name }}" 
                                      rows="3" 
                                      placeholder="Enter your complete address including apartment/unit number..."
                                      required>{{ form.address.value|default:'' }}</textarea>
                        </div>

                        <div class="form-group" style="margin-bottom: 1.5rem;">
                            <label for="{{ form.phone_number.id_for_label }}" class="form-label">
                                <i class="fas fa-phone" style="color: #06b6d4;"></i>Phone Number
                            </label>
                            {{ form.phone_number }}
                        </div>

                        <div class="form-group" style="margin-bottom: 2rem;">
                            <label for="{{ form.notes.id_for_label }}" class="form-label">
                                <i class="fas fa-sticky-note" style="color: #64748b;"></i>Special Instructions (Optional)
                            </label>
                            <textarea class="form-control" 
                                      id="{{ form.notes.id_for_label }}" 
                                      name="{{ form.notes.name }}" 
                                      rows="3" 
                                      placeholder="Any special instructions, stain information, or preferences...">{{ form.notes.value|default:'' }}</textarea>
                        </div>

                        <!-- Cost Estimate -->
                        <div class="info-alert">
                            <i class="fas fa-calculator"></i>
                            <div class="info-alert-content">
                                <h6>Estimated Cost</h6>
                                <p>Base service fee + per-item charges will be calculated after pickup inspection. Final cost may vary based on actual items and services required.</p>
                            </div>
                        </div>

                        <!-- Form Actions -->
                        <div class="form-actions">
                            <a href="{% url 'reservations:reservation_list' %}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left"></i>Cancel
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-{% if object %}save{% else %}calendar-check{% endif %}"></i>
                                {% if object %}Update Reservation{% else %}Schedule Pickup{% endif %}
                            </button>
                        </div>
                    </form>
                </div>
            </div>

                <!-- Help Section -->
                <div class="help-section">
                    <div class="help-card">
                        <i class="fas fa-clock help-icon" style="color: #2563eb;"></i>
                        <h6>Flexible Scheduling</h6>
                        <p>Choose pickup and delivery times that work for your schedule.</p>
                    </div>
                    <div class="help-card">
                        <i class="fas fa-shield-alt help-icon" style="color: #10b981;"></i>
                        <h6>Safe & Secure</h6>
                        <p>Your items are tracked and insured throughout the process.</p>
                    </div>
                    <div class="help-card">
                        <i class="fas fa-headset help-icon" style="color: #06b6d4;"></i>
                        <h6>24/7 Support</h6>
                        <p>Contact us anytime if you need to modify your reservation.</p>
                    </div>
                </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Sync service type display with actual form field
    const serviceTypeInputs = document.querySelectorAll('input[name="service_type_display"]');
    const serviceTypeField = document.getElementById('{{ form.service_type.id_for_label }}');
    
    serviceTypeInputs.forEach(input => {
        input.addEventListener('change', function() {
            if (serviceTypeField) {
                serviceTypeField.value = this.value;
            }
        });
        
        // Set initial value if form has data
        if (serviceTypeField && serviceTypeField.value == input.value) {
            input.checked = true;
        }
    });
    
    // Sync priority display with actual form field
    const priorityInputs = document.querySelectorAll('input[name="priority_display"]');
    const priorityField = document.getElementById('{{ form.priority.id_for_label }}');
    
    priorityInputs.forEach(input => {
        input.addEventListener('change', function() {
            if (priorityField) {
                priorityField.value = this.value;
            }
            updateDeliveryTime();
        });
        
        // Set initial value if form has data
        if (priorityField && priorityField.value == input.value) {
            input.checked = true;
        }
    });
    
    // Auto-calculate delivery time based on priority
    const pickupInput = document.getElementById('{{ form.pickup_datetime.id_for_label }}');
    const deliveryInput = document.getElementById('{{ form.delivery_datetime.id_for_label }}');
    
    function updateDeliveryTime() {
        if (!pickupInput.value) return;
        
        const pickupDate = new Date(pickupInput.value);
        const priorityChecked = document.querySelector('input[name="priority_display"]:checked');
        const priority = priorityChecked ? priorityChecked.value : 'standard';
        let deliveryDate = new Date(pickupDate);
        
        switch(priority) {
            case 'rush':
                deliveryDate.setHours(deliveryDate.getHours() + 8); // Same day
                break;
            case 'express':
                deliveryDate.setDate(deliveryDate.getDate() + 1); // Next day
                break;
            default:
                deliveryDate.setDate(deliveryDate.getDate() + 3); // 3 days
        }
        
        deliveryInput.value = deliveryDate.toISOString().slice(0, 16);
    }
    
    pickupInput.addEventListener('change', updateDeliveryTime);
    
    // Form validation
    const form = document.querySelector('.needs-validation');
    form.addEventListener('submit', function(event) {
        // Ensure hidden fields are synced before submit
        const serviceTypeChecked = document.querySelector('input[name="service_type_display"]:checked');
        if (serviceTypeChecked && serviceTypeField) {
            serviceTypeField.value = serviceTypeChecked.value;
        }
        
        const priorityChecked = document.querySelector('input[name="priority_display"]:checked');
        if (priorityChecked && priorityField) {
            priorityField.value = priorityChecked.value;
        }
        
        if (!form.checkValidity()) {
            event.preventDefault();
            event.stopPropagation();
        }
        form.classList.add('was-validated');
    });
});
</script>
{% endblock %}
